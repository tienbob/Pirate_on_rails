<% content_for :head do %>
  <!-- External fonts with display swap -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <%= stylesheet_link_tag 'cinema_series_show', media: 'all' %>
<% end %>

<% cache("series_#{@series.id}_show_v2", expires_in: 30.minutes) do %>
<% 
  # Create static image URL to prevent repeated backend calls
  cached_series_image_url = Rails.cache.fetch("series_static_url_#{@series.id}_v4", expires_in: 24.hours) do
    series_static_image_url(@series)
  end
%>
<div class="series-hero-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="series-showcase-card p-5">
          <div class="row align-items-start">
            <div class="col-lg-4 mb-4 mb-lg-0">
              <div class="series-poster-container">
                <div class="series-poster" 
                     style="background-image: url('<%= cached_series_image_url %>');"
                     role="img" 
                     aria-label="<%= @series.title %>">
                </div>
              </div>
            </div>
            
            <div class="col-lg-8">
              <h1 class="series-title"><%= @series.title %></h1>
              <p class="series-description"><%= @series.description %></p>
              
              <% if @series.tags.any? %>
                <div class="series-tags">
                  <span class="series-tags-label">
                    <i class="fas fa-tags me-2"></i>Genres & Tags
                  </span>
                  <div>
                    <% @series.tags.each do |tag| %>
                      <span class="series-tag"><%= tag.name %></span>
                    <% end %>
                  </div>
                </div>
              <% end %>
              
              <% if current_user&.admin? %>
                <div class="admin-actions">
                  <%= link_to new_movie_path(series_id: @series.id), 
                      class: 'admin-btn admin-btn-primary' do %>
                    <i class="fas fa-plus me-2"></i>Add Episode
                  <% end %>
                  <%= link_to edit_series_path(@series), 
                      class: 'admin-btn admin-btn-warning' do %>
                    <i class="fas fa-edit me-2"></i>Edit Series
                  <% end %>
                  <%= button_to series_path(@series), 
                      method: :delete, 
                      data: { confirm: 'Are you sure you want to delete this series and all its episodes? This cannot be undone.' }, 
                      class: 'admin-btn admin-btn-danger' do %>
                    <i class="fas fa-trash me-2"></i>Delete Series
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
          
          <% cache("series_#{@series.id}_episodes_page_#{@episodes.current_page}_v3", expires_in: 30.minutes) do %>
          <div class="episodes-section">
            <h2 class="episodes-title">
              <i class="fas fa-play-circle me-2"></i>
              Episodes (<%= @episodes.total_count if @episodes.respond_to?(:total_count) %>)
            </h2>
            
            <div class="row g-4">
              <% @episodes.each do |movie| %>
                <div class="col-md-6 col-xl-4">
                  <div class="episode-card">
                    <div class="episode-image" 
                         style="background-image: url('<%= cached_series_image_url %>');"
                         role="img" 
                         aria-label="<%= @series.title %>">
                    </div>
                    
                    <div class="episode-body">
                      <h5 class="episode-title"><%= movie.title %></h5>
                      <p class="episode-date">
                        <% if movie.release_date %>
                          <i class="fas fa-calendar-alt me-1"></i>
                          <%= movie.release_date.strftime('%B %d, %Y') %>
                        <% end %>
                      </p>
                      
                      <% if movie.is_pro %>
                        <span class="episode-badge pro">
                          <i class="fas fa-crown me-1"></i>Pro
                        </span>
                      <% else %>
                        <span class="episode-badge free">
                          <i class="fas fa-unlock me-1"></i>Free
                        </span>
                      <% end %>
                      
                      <p class="episode-description">
                        <%= truncate(movie.description, length: 100) %>
                      </p>
                      
                      <div class="episode-actions">
                        <%= link_to movie_path(movie), 
                            class: 'episode-btn episode-btn-primary' do %>
                          <i class="fas fa-play me-2"></i>Watch Episode
                        <% end %>
                        <% if current_user&.admin? %>
                          <%= link_to edit_movie_path(movie), 
                              class: 'episode-btn episode-btn-outline' do %>
                            <i class="fas fa-edit me-2"></i>Edit
                          <% end %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
            
            <div class="pagination-container">
              <%= paginate @episodes %>
            </div>
          </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
<% end %>
