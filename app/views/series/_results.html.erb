
<div id="search-loading" class="text-center py-5" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3 text-white">Searching series...</p>
</div>

<div id="search-results">
<% if @series.any? %>
  <div class="row g-4">
    <% @series.each do |series| %>
      <% cache [series, series.tags.maximum(:updated_at)] do %>
        <% 
          # Use cached direct URL without going through helper to prevent repeated calls
          cached_image_url = Rails.cache.fetch("series_direct_url_#{series.id}_v3", expires_in: 24.hours) do
            if series.img.attached?
              # Generate URL once and cache it for 24 hours
              url_for(series.img)
            else
              asset_url('series/default.JPG')
            end
          end
        %>
        <div class="col-md-6 col-lg-4">
          <div class="series-card">
            <div class="series-card-image">
              <%= image_tag cached_image_url, 
                  alt: series.title, 
                  loading: "lazy",
                  decoding: "async",
                  width: "320",
                  height: "180",
                  class: "img-fluid" %>
            </div>
            <div class="series-card-body">
              <h5 class="series-card-title"><%= series.title %></h5>
              <p class="series-card-description">
                <%= truncate(series.description, length: 120) %>
              </p>
              <% if series.tags.loaded? && series.tags.any? %>
                <div class="series-card-tags">
                  <% series.tags.first(3).each do |tag| %>
                    <span class="series-card-tag"><%= tag.name %></span>
                  <% end %>
                </div>
              <% end %>
              <%= link_to series_path(series), 
                  class: 'series-card-btn', 
                  data: { turbo: false } do %>
                <i class="fas fa-tv me-2"></i>Explore Series
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
  <% if @series.respond_to?(:total_pages) %>
    <div class="pagination-container">
      <%= paginate @series %>
    </div>
  <% end %>
<% else %>
  <div class="alert alert-info text-center">No series found matching your search.</div>
<% end %>
</div>
