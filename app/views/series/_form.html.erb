<% content_for :head do %>
  <%= stylesheet_link_tag 'cinema_series_form', media: 'all' %>
<% end %>

<%= form_with(model: series, local: true, html: { multipart: true, data: { turbo: false } }) do |form| %>
  <div class="form-group-series">
    <%= form.label :title, class: 'form-label-series' do %>
      <i class="fas fa-tv me-2"></i>Series Title
    <% end %>
    <%= form.text_field :title,
        class: 'form-control-series',
        placeholder: 'Enter the series title...',
        required: true %>
  </div>

  <div class="form-group-series">
    <%= form.label :description, class: 'form-label-series' do %>
      <i class="fas fa-align-left me-2"></i>Description
    <% end %>
    <%= form.text_area :description,
        class: 'form-control-series form-textarea-series',
        placeholder: 'Describe the series plot, themes, and what makes it special...',
        required: true %>
  </div>

  <div class="form-group-series" data-controller="file-upload">
    <%= form.label :img, class: 'form-label-series' do %>
      <i class="fas fa-image me-2"></i>Series Poster Image
    <% end %>
    <div class="file-input-container-series">
      <%= form.file_field :img,
          accept: "image/*",
          class: 'form-control',
          direct_upload: true,
          data: { file_upload_target: "input" } %>
      <div class="file-input-text-series" data-file-upload-target="text">
        <i class="fas fa-cloud-upload-alt mb-2" style="font-size: 2rem; color: #64748b;"></i>
        <p>Click to upload poster image or drag and drop</p>
        <p style="font-size: 0.75rem;">Supported formats: JPG, PNG, WebP</p>
      </div>
    </div>
    <div data-file-upload-target="preview"></div>
  </div>

  <div class="form-group-series">
    <%= form.label :tags, class: 'form-label-series' do %>
      <i class="fas fa-tags me-2"></i>Genres & Tags
    <% end %>
    <div class="tags-grid-series" data-controller="series-form" data-series-form-target="tagSelect selectedTags">
      <% Tag.all.each do |tag| %>
        <div class="tag-checkbox-series">
          <%= check_box_tag "series[tag_ids][]",
              tag.id,
              series.tags.include?(tag),
              id: "tag_#{tag.id}" %>
          <label for="tag_<%= tag.id %>"><%= tag.name %></label>
        </div>
      <% end %>
      <input type="hidden" data-series-form-target="selectedTags" />
    </div>
  </div>

  <div class="form-group-series">
    <%= form.submit series.persisted? ? 'Update Series' : 'Create Series', 
        class: 'submit-button-series',
        data: { disable_with: 'Creating Series...' } %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const submitButton = form.querySelector('.submit-button-series');
  
  console.log('Series form script loaded', { form, submitButton });
  
  if (form) {
    form.addEventListener('submit', function(e) {
      console.log('Series form submit event triggered');
      
      // Check if all required fields are filled
      const title = form.querySelector('input[name="series[title]"]');
      const description = form.querySelector('textarea[name="series[description]"]');
      const imageFile = form.querySelector('input[name="series[img]"]');
      
      if (!title || !title.value.trim()) {
        e.preventDefault();
        alert('Please enter a series title');
        return;
      }
      
      if (!description || !description.value.trim()) {
        e.preventDefault();
        alert('Please enter a description');
        return;
      }
      
      // Check image file if selected
      if (imageFile && imageFile.files && imageFile.files.length > 0) {
        const file = imageFile.files[0];
        const fileSizeMB = file.size / (1024 * 1024);
        
        // Check file size (warn if over 10MB for images)
        if (fileSizeMB > 10) {
          e.preventDefault();
          alert(`Image size is ${Math.round(fileSizeMB)}MB. Please use an image smaller than 10MB for better performance.`);
          return;
        }
        
        // Check if it's actually an image
        if (!file.type.startsWith('image/')) {
          e.preventDefault();
          alert('Please select a valid image file (JPG, PNG, WebP)');
          return;
        }
      }
      
      console.log('Series form validation passed, submitting...');
      
      // Show loading state
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = `
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Creating Series...
        `;
      }
      
      // Show upload progress message if there's an image
      if (imageFile && imageFile.files && imageFile.files.length > 0) {
        const progressDiv = document.createElement('div');
        progressDiv.className = 'upload-progress mt-3';
        progressDiv.innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-upload me-2"></i>
            Creating series and uploading poster image...
            <br><small>Please wait while we process your request.</small>
          </div>
        `;
        form.appendChild(progressDiv);
      }
    });
  }
  
  if (submitButton) {
    submitButton.addEventListener('click', function(e) {
      console.log('Series submit button clicked');
    });
  }
});
</script>
