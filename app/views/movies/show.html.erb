<% content_for :head do %>
  <%= stylesheet_link_tag 'cinema_movie_show', media: 'all' %>
  <% content_for :preload_images do %>
    <% if @movie.video_file.attached? %>
      <%= preload_link_tag url_for(@movie.video_file), as: :video %>
    <% end %>
  <% end %>
<% end %>

<div class="movie-hero-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="movie-showcase-card p-5">
          <div class="row align-items-center">
            <div class="col-lg-6 mb-4 mb-lg-0">
              <div class="movie-video-container" 
                   data-controller="video-analytics" 
                   data-video-analytics-movie-id-value="<%= @movie.id %>" 
                   data-video-analytics-csrf-token-value="<%= form_authenticity_token %>">
                <% if @movie.video_file.attached? && @movie.viewable_by?(current_user) %>
                  <%= video_tag @movie.cached_video_url || url_for(@movie.video_file), 
                      controls: true, 
                      class: "movie-video", 
                      preload: "metadata",
                      data: { 
                        "video-analytics-target": "video"
                      } %>
                <% elsif @movie.video_file.attached? && !@movie.viewable_by?(current_user) %>
                  <div class="movie-placeholder pro-content-locked">
                    <i class="fas fa-lock me-2"></i>
                    <div>
                      <h5>Pro Content</h5>
                      <p>Upgrade to Pro to watch this content</p>
                      <%= link_to "Upgrade Now", upgrade_payment_path, class: "btn btn-primary btn-sm" %>
                    </div>
                  </div>
                <% else %>
                  <div class="movie-placeholder">
                    <i class="fas fa-film me-2"></i>
                    No video available
                  </div>
                <% end %>
              </div>
            </div>
            
            <div class="col-lg-6">
              <h1 class="movie-title"><%= sanitize @movie.title %></h1>
              <div class="movie-meta">
                <% if @movie.release_date %>
                  <i class="fas fa-calendar-alt me-2"></i>
                  Released <%= @movie.release_date.strftime('%B %d, %Y') %>
                <% end %>
                <% if @movie.formatted_duration %>
                  <i class="fas fa-clock ms-3 me-2"></i>
                  <%= @movie.formatted_duration %>
                <% end %>
              </div>
              
              <% if @movie.is_pro? %>
                <div class="movie-badge pro">
                  <i class="fas fa-crown me-2"></i>Pro Content
                </div>
              <% else %>
                <div class="movie-badge free">
                  <i class="fas fa-unlock me-2"></i>Free to Watch
                </div>
              <% end %>
              
              <p class="movie-description"><%= sanitize @movie.description %></p>
              
              <% if @movie.tags.any? %>
                <div class="movie-tags">
                  <span class="movie-tags-label">
                    <i class="fas fa-tags me-2"></i>Genres
                  </span>
                  <div>
                    <% @movie.tags.limit(5).each do |tag| %>
                      <span class="movie-tag"><%= sanitize tag.name %></span>
                    <% end %>
                    <% if @movie.tags.count > 5 %>
                      <span class="movie-tag-more">+<%= @movie.tags.count - 5 %> more</span>
                    <% end %>
                  </div>
                </div>
              <% end %>
              
              <!-- Related Movies Section -->
              <% if @movie.related_movies.any? %>
                <div class="related-movies-preview">
                  <h6><i class="fas fa-film me-2"></i>You might also like</h6>
                  <div class="related-movies-list">
                    <% @movie.related_movies.limit(3).each do |related| %>
                      <% if related.viewable_by?(current_user) %>
                        <%= link_to movie_path(related), class: "related-movie-link" do %>
                          <small><%= sanitize related.title %></small>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>
              
              <div class="movie-actions">
                <% if @movie.series %>
                  <%= link_to series_path(@movie.series), class: 'movie-btn movie-btn-secondary' do %>
                    <i class="fas fa-arrow-left me-2"></i>Back to Series
                  <% end %>
                <% else %>
                  <%= link_to series_index_path, class: 'movie-btn movie-btn-secondary' do %>
                    <i class="fas fa-arrow-left me-2"></i>Back to Series List
                  <% end %>
                <% end %>
                <% if current_user&.admin? %>
                  <%= link_to edit_movie_path(@movie), class: 'movie-btn movie-btn-primary' do %>
                    <i class="fas fa-edit me-2"></i>Edit Movie
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
