<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 text-white">
  <div class="container mx-auto px-4 py-6">
    <div class="max-w-3xl mx-auto">
      
      <!-- Hero Header -->
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-3">
          <i class="fas fa-check-circle text-white fa-lg"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Subscription Management</h1>
        <p class="text-lg text-gray-600">
          You're enjoying <span class="font-semibold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Pro Access</span> ✨
        </p>
      </div>

      <% if @subscription_info %>
        <!-- Main Subscription Card -->
        <div class="rounded-xl shadow-lg overflow-hidden mb-6" style="background:rgba(15,23,42,0.85);border:1px solid #334155;">
          <!-- Status Banner -->
          <div class="<%= @subscription_info[:cancel_at_period_end] ? 'bg-gradient-to-r from-yellow-400 to-orange-500' : 'bg-gradient-to-r from-green-400 to-blue-500' %> px-4 py-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <% if @subscription_info[:cancel_at_period_end] %>
                    <i class="fas fa-exclamation-triangle text-white"></i>
                  <% else %>
                    <i class="fas fa-check-circle text-white"></i>
                  <% end %>
                </div>
                <div class="ml-3">
                  <h3 class="text-base font-semibold text-white">
                    <%= @subscription_info[:cancel_at_period_end] ? 'Subscription Ending Soon' : 'Active Pro Subscription' %>
                  </h3>
                  <p class="text-sm text-white/90">
                    <%= @subscription_info[:cancel_at_period_end] ? 'Will not renew automatically' : 'Automatically renewing' %>
                  </p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold text-white">
                  $<%= sprintf("%.2f", @subscription_info[:amount]) %>
                </div>
                <div class="text-xs text-white/90 uppercase tracking-wide">
                  per <%= @subscription_info[:interval] %>
                </div>
              </div>
            </div>
          </div>

          <!-- Subscription Details -->
          <div class="p-4" style="background:rgba(30,41,59,0.7);border-radius:0 0 1rem 1rem;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Current Period -->
              <div class="text-center p-3 rounded-lg" style="background:rgba(30,41,59,0.5);color:#e2e8f0;">
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Current Period</div>
                <div class="text-sm font-semibold text-gray-900">
                  <%= @subscription_info[:created].present? ? @subscription_info[:created].strftime('%b %d') : 'N/A' %>
                  -
                  <%= @subscription_info[:next_billing_date].present? ? @subscription_info[:next_billing_date].strftime('%b %d, %Y') : 'N/A' %>
                </div>
              </div>

              <!-- Next Billing -->
              <div class="text-center p-3 rounded-lg" style="background:rgba(30,41,59,0.5);color:#e2e8f0;">
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Next Billing</div>
                <div class="text-sm font-semibold text-gray-900">
                  <% if @subscription_info[:cancel_at_period_end] %>
                    <span class="text-red-600">Will Not Renew</span>
                  <% else %>
                    <%= @subscription_info[:next_billing_date].present? ? @subscription_info[:next_billing_date].strftime('%b %d, %Y') : 'N/A' %>
                  <% end %>
                </div>
              </div>

              <!-- Status -->
              <div class="text-center p-3 rounded-lg" style="background:rgba(30,41,59,0.5);color:#e2e8f0;">
                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Status</div>
                <div class="text-sm font-semibold">
                  <% if @subscription_info[:cancel_at_period_end] %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                      <i class="fas fa-exclamation-triangle mr-1 fa-xs"></i>
                      Cancelling
                    </span>
                  <% else %>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      <i class="fas fa-check mr-1 fa-xs"></i>
                      Active
                    </span>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          
          <!-- Billing Portal Card -->
          <div class="rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow duration-300" style="background:rgba(30,41,59,0.85);border:1px solid #334155;">
            <div class="flex items-center mb-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                  <i class="fas fa-credit-card text-blue-600"></i>
                </div>
              </div>
              <div class="ml-3">
                <h3 class="text-base font-semibold text-gray-900">Billing Portal</h3>
                <p class="text-sm text-gray-500">Manage payment methods & invoices</p>
              </div>
            </div>
            <p class="text-gray-600 mb-3 text-sm">
              Access Stripe's secure portal to update your payment methods, download invoices, and view billing history.
            </p>
            <% checkout_session_id = Payment.where(user: current_user, status: 'completed').order(created_at: :desc).limit(1).pluck(:stripe_charge_id).first %>
            <button
              onclick="openBillingPortal('<%= create_portal_session_payments_path(session_id: checkout_session_id) %>')"
              class="inline-flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-700 text-gray-900 text-sm font-medium rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              <i class="fas fa-external-link-alt mr-2"></i>
              Open Portal
            </button>
            <script>
            function openBillingPortal(url) {
              const popup = window.open(url, 'BillingPortal', 'width=800,height=700');
              const timer = setInterval(function() {
                if (popup.closed) {
                  clearInterval(timer);
                  window.location.reload();
                }
              }, 1000);
            }
            </script>
          </div>

          <!-- Cancellation Card -->
          <div class="rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow duration-300" style="background:rgba(30,41,59,0.85);border:1px solid #334155;">
            <% if @subscription_info[:cancel_at_period_end] %>
              <!-- Already Cancelled State -->
              <div class="flex items-center mb-3">
                <div class="flex-shrink-0">
                  <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                  </div>
                </div>
                <div class="ml-3">
                  <h3 class="text-base font-semibold text-white">Subscription Cancelled</h3>
                  <p class="text-sm text-white">Your subscription will end soon</p>
                </div>
              </div>
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <p class="text-sm text-yellow-700 mb-1">
                  <strong>Access until:</strong> <%= @subscription_info[:next_billing_date].present? ? @subscription_info[:next_billing_date].strftime('%B %d, %Y') : 'N/A' %>
                </p>
                <% if @subscription_info[:cancelled_at].present? %>
                  <p class="text-xs text-yellow-600">
                    Cancelled on <%= @subscription_info[:cancelled_at].strftime('%B %d, %Y at %I:%M %p') %>
                  </p>
                <% end %>
              </div>
            <% else %>
              <!-- Active Subscription - Allow Cancellation -->
              <div class="flex items-center mb-3">
                <div class="flex-shrink-0">
                  <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-times text-red-600"></i>
                  </div>
                </div>
              </div>
              <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                <p class="text-sm text-red-700 mb-2">
                  <strong>What happens if you cancel?</strong><br>
                  You will keep full Pro access until <span class="font-semibold text-red-800"><%= @subscription_info[:next_billing_date].present? ? @subscription_info[:next_billing_date].strftime('%B %d, %Y') : 'N/A' %></span>.<br>
                  After this date, your account will automatically switch to the Free plan.<br>
                  You can reactivate Pro anytime from your dashboard.
                </p>
                <p class="text-xs text-gray-700 mb-2">
                  Need more info? <a href="#" class="underline text-blue-600 hover:text-blue-800">See Subscription FAQs</a> or <a href="#" class="underline text-blue-600 hover:text-blue-800">Contact Support</a>.
                </p>
                <p class="text-xs text-gray-500">
                  <i class="fas fa-info-circle mr-1"></i> Cancellation only affects future renewals. You will not be charged again unless you reactivate.
                </p>
              </div>
              <%= form_with url: cancel_subscription_path, method: :post, local: true, 
                  data: { 
                    confirm: "⚠️ Are you sure you want to cancel?\n\nYou'll lose Pro features at the end of your billing period." 
                  } do |form| %>
                <%= form.submit "Cancel Subscription", 
                    class: "inline-flex items-center px-3 py-2 bg-red-600 hover:bg-red-700 text-gray-900 text-sm font-medium rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" %>
              <% end %>
            <% end %>
          </div>
        </div>

        <!-- Pro Features Reminder -->
        <div class="rounded-lg shadow-md p-4 text-white mb-6" style="background:linear-gradient(135deg, #6366f1 0%, #2563eb 100%);border:1px solid #334155;">
          <h3 class="text-lg font-semibold mb-3">Your Pro Features</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="flex items-center text-sm">
              <i class="fas fa-infinity mr-2"></i>
              <span>Unlimited Access</span>
            </div>
            <div class="flex items-center text-sm">
              <i class="fas fa-star mr-2"></i>
              <span>Premium Content</span>
            </div>
            <div class="flex items-center text-sm">
              <i class="fas fa-headset mr-2"></i>
              <span>Priority Support</span>
            </div>
          </div>
        </div>

      <% else %>
        <!-- No Subscription Found -->
        <div class="rounded-lg shadow-md p-6 text-center" style="background:rgba(30,41,59,0.85);border:1px solid #334155;color:#e2e8f0;">
          <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="fas fa-exclamation-triangle text-yellow-600 fa-lg"></i>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">No Active Subscription</h3>
          <p class="text-gray-600 mb-4 text-sm">
            We couldn't find an active subscription for your account. If you believe this is an error, please contact our support team.
          </p>
          <div class="flex flex-col sm:flex-row gap-2 justify-center">
            <%= link_to "Upgrade to Pro", "#", 
                class: "inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors duration-200" %>
            <%= link_to "Contact Support", "#", 
                class: "inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors duration-200" %>
          </div>
        </div>
      <% end %>

      <!-- Navigation -->
      <div class="text-center mt-4">
        <%= link_to series_index_path, 
            class: "inline-flex items-center text-gray-600 hover:text-gray-900 text-sm font-medium transition-colors duration-200" do %>
          <i class="fas fa-arrow-left mr-2"></i>
          Back to Dashboard
        <% end %>
      </div>
    </div>
  </div>
</div>
