<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Pirate On Rails" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
         <button type="button" data-chat-target="open" class="cinema-chat-button" style="position:fixed;bottom:24px;right:24px;z-index:9998;">
          <i class="fas fa-comments"></i>
        </button>  <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <% if user_signed_in? %>
      <meta name="current-user-id" content="<%= current_user.id %>">
    <% end %>

    <!-- Global Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/new_icon.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "cinema_header", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "cinema_footer", "data-turbo-track": "reload" %>

    <!-- Global Cinema Theme Styles -->
    <style>
      :root {
        --cinema-dark-navy: #060D1E;
        --cinema-midnight: #11182D;
        --cinema-royal-blue: #1E3A8A;
        --cinema-bright-blue: #3B82F6;
        --cinema-light-blue: #60A5FA;
        --cinema-text-primary: #FFFFFF;
        --cinema-text-secondary: #E2E8F0;
        --cinema-text-muted: #CBD5E1;
        --cinema-border: rgba(59, 130, 246, 0.3);
        --cinema-shadow: rgba(59, 130, 246, 0.2);
      }
      
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, var(--cinema-dark-navy) 0%, var(--cinema-midnight) 25%, var(--cinema-royal-blue) 75%, var(--cinema-bright-blue) 100%);
        background-attachment: fixed;
        color: var(--cinema-text-secondary);
        min-height: 100vh;
      }
      
      .cinema-main-content {
        background: rgba(15, 23, 42, 0.3);
        backdrop-filter: blur(10px);
        border-radius: 0;
        min-height: calc(100vh - 140px);
        padding: 0;
      }
      
      .cinema-alert {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid var(--cinema-border);
        border-radius: 12px;
        color: var(--cinema-text-primary);
        box-shadow: 0 10px 25px var(--cinema-shadow);
        font-family: 'Inter', sans-serif;
      }
      
      .cinema-alert.alert-success {
        border-left: 4px solid #10b981;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(15, 23, 42, 0.95) 25%);
      }
      
      .cinema-alert.alert-danger {
        border-left: 4px solid #ef4444;
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(15, 23, 42, 0.95) 25%);
      }
      
      .cinema-alert.alert-info {
        border-left: 4px solid var(--cinema-bright-blue);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(15, 23, 42, 0.95) 25%);
      }
      
      .cinema-chat-popup {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid var(--cinema-border);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 10px 25px var(--cinema-shadow);
      }
      
      .cinema-chat-header {
        background: linear-gradient(135deg, var(--cinema-bright-blue) 0%, var(--cinema-royal-blue) 100%);
        color: var(--cinema-text-primary);
        padding: 12px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: 'Inter', sans-serif;
      }
      
      .cinema-chat-close {
        background: none;
        border: none;
        color: var(--cinema-text-primary);
        font-size: 1.2em;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.3s ease;
      }
      
      .cinema-chat-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      
      .cinema-chat-messages {
        padding: 12px;
        min-height: 120px;
        max-height: 220px;
        overflow-y: auto;
        color: var(--cinema-text-muted);
        font-size: 0.95em;
        font-family: 'Inter', sans-serif;
      }
      
      .cinema-chat-form {
        display: flex;
        border-top: 1px solid var(--cinema-border);
      }
      
      .cinema-chat-input {
        flex: 1;
        padding: 8px;
        border: none;
        outline: none;
        resize: none;
        min-height: 38px;
        max-height: 120px;
        overflow-y: auto;
        background: rgba(30, 41, 59, 0.8);
        color: var(--cinema-text-secondary);
        font-family: 'Inter', sans-serif;
      }
      
      .cinema-chat-input::placeholder {
        color: var(--cinema-text-muted);
      }
      
      .cinema-chat-send {
        background: linear-gradient(135deg, var(--cinema-bright-blue) 0%, var(--cinema-royal-blue) 100%);
        color: var(--cinema-text-primary);
        border: none;
        padding: 0 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-family: 'Inter', sans-serif;
      }
      
      .cinema-chat-send:hover {
        background: linear-gradient(135deg, var(--cinema-royal-blue) 0%, var(--cinema-midnight) 100%);
      }
      
      .cinema-chat-button {
        background: linear-gradient(135deg, var(--cinema-bright-blue) 0%, var(--cinema-royal-blue) 100%);
        color: var(--cinema-text-primary);
        border: none;
        border-radius: 50%;
        width: 56px;
        height: 56px;
        box-shadow: 0 8px 25px var(--cinema-shadow), 0 4px 12px rgba(0, 0, 0, 0.3);
        font-size: 1.6em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .cinema-chat-button:hover {
        background: linear-gradient(135deg, var(--cinema-royal-blue) 0%, var(--cinema-midnight) 100%);
        transform: translateY(-2px);
        box-shadow: 0 12px 35px var(--cinema-shadow), 0 6px 20px rgba(0, 0, 0, 0.4);
      }
    </style>

    <%= javascript_importmap_tags %>
  </head>

  <body class="d-flex flex-column min-vh-100">
    <%= render 'layouts/header' %>
    <main class="flex-grow-1">
      <div class="container-fluid">
        <div class="row h-100">
          <div class="col-12">
            <div class="cinema-main-content">
              <% flash.each do |type, message| %>
                <% next if message.blank? %>
                <% bs_class = case type.to_sym
                  when :notice then 'alert-success'
                  when :alert then 'alert-danger'
                  when :error then 'alert-danger'
                  when :success then 'alert-success'
                  else 'alert-info'
                end %>
                <div class="alert cinema-alert <%= bs_class %> alert-dismissible fade show" role="alert" style="position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; min-width: 300px; max-width: 90vw;">
                  <%= message %>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              <% end %>
              <%= yield %>
            </div>
          </div>
        </div>
      </div>
    </main>
    <%= render 'layouts/footer' %>

    <!-- Chat Popup Widget using Stimulus (only for logged-in users) -->
    <% if current_user %>
      <div data-controller="chat">
        <div id="chat-popup" data-chat-target="popup" class="cinema-chat-popup" style="position:fixed;bottom:24px;right:24px;z-index:9999;max-width:350px;border-radius:12px;overflow:hidden;display:none;flex-direction:column;">
          <div class="cinema-chat-header">
            <span><i class="fas fa-comments me-2"></i>Chat Support</span>
            <button type="button" data-chat-target="close" class="cinema-chat-close">&times;</button>
          </div>
          <div class="cinema-chat-messages" data-chat-target="messages">
            <div><i class="fas fa-robot me-2"></i>Hi! How can we help you today?</div>
          </div>
          <form data-chat-target="form" class="cinema-chat-form">
            <textarea data-chat-target="input" placeholder="Type your message..." rows="1" class="cinema-chat-input"></textarea>
            <button type="submit" class="cinema-chat-send">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </div>
        <button type="button" data-chat-target="open" style="position:fixed;bottom:24px;right:24px;z-index:9998;background:#007bff;color:#fff;border:none;border-radius:50%;width:56px;height:56px;box-shadow:0 2px 8px rgba(0,0,0,0.18);font-size:1.6em;cursor:pointer;display:flex;align-items:center;justify-content:center;">ï¿½</button>
      </div>
    <% end %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
