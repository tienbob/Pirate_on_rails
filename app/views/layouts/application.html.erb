<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Pirate On Rails" %></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <% if user_signed_in? %>
      <meta name="current-user-id" content="<%= current_user.id %>">
    <% end %>

    <!-- Preload critical resources -->
    <%= preload_link_tag asset_path('cinema_bundle.css'), as: :style %>
    
    <!-- Critical inline CSS for above-the-fold content -->
    <style>
      /* Critical CSS inlined for faster rendering */
      body { 
        margin: 0; 
        font-family: 'Inter', sans-serif; 
        background: linear-gradient(135deg, #060D1E 0%, #11182D 25%, #1E3A8A 75%, #3B82F6 100%);
        background-attachment: fixed;
        color: #E2E8F0; 
        min-height: 100vh;
      }
      /* Critical header link overrides */
      .navbar a, .navbar a:link, .navbar a:visited, .navbar a:hover {
        color: #e2e8f0 !important;
        text-decoration: none !important;
      }
      .cinema-nav-link, .cinema-nav-link:link, .cinema-nav-link:visited {
        color: #e2e8f0 !important;
        text-decoration: none !important;
        font-family: 'Inter', sans-serif;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      .cinema-nav-link:hover {
        color: #ffffff !important;
        background: linear-gradient(135deg, rgba(96, 165, 250, 0.2) 0%, rgba(59, 130, 246, 0.3) 100%);
        text-decoration: none !important;
      }
      .navbar { 
        background: linear-gradient(135deg, rgba(6, 13, 30, 0.98) 0%, rgba(17, 24, 45, 0.95) 25%, rgba(30, 58, 138, 0.92) 75%, rgba(59, 130, 246, 0.9) 100%);
        backdrop-filter: blur(20px);
      }
      .loading { 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 200px; 
      }
      .cinema-main-content {
        background: rgba(15, 23, 42, 0.3);
        backdrop-filter: blur(10px);
        min-height: calc(100vh - 140px);
      }
      /* Critical chat widget styles */
      .cinema-chat-button {
        background: linear-gradient(135deg, #3B82F6 0%, #1E3A8A 100%);
        color: #ffffff;
        border: none;
        border-radius: 50%;
        width: 56px;
        height: 56px;
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3), 0 4px 12px rgba(0, 0, 0, 0.3);
        font-size: 1.6em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 9998;
        transition: all 0.3s ease;
      }
      .cinema-chat-button:hover {
        background: linear-gradient(135deg, #1E3A8A 0%, #11182D 100%);
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4), 0 6px 20px rgba(0, 0, 0, 0.4);
      }
      .cinema-chat-popup {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(59, 130, 246, 0.3);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 10px 25px rgba(59, 130, 246, 0.2);
        font-family: 'Inter', sans-serif;
      }
    </style>

    <!-- External fonts with display swap for better performance -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <!-- External CSS with performance optimizations -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" media="print" onload="this.media='all'">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" media="print" onload="this.media='all'">

    <!-- Core cinema theme styles -->
    <%= stylesheet_link_tag 'cinema_theme', 'cinema_header', 'cinema_footer', "data-turbo-track": "reload", media: "all" %>

    <%= yield :head %>
    <%= javascript_importmap_tags %>
    
    <!-- Preload key images -->
    <% if content_for?(:preload_images) %>
      <%= yield :preload_images %>
    <% end %>
  </head>

  <body class="d-flex flex-column min-vh-100">
    <%= render 'layouts/header' %>
    <main class="flex-grow-1">
      <div class="container-fluid">
        <div class="row h-100">
          <div class="col-12">
            <div class="cinema-main-content">
              <% flash.each do |type, message| %>
                <% next if message.blank? %>
                <% bs_class = case type.to_sym
                  when :notice then 'alert-success'
                  when :alert then 'alert-danger'
                  when :error then 'alert-danger'
                  when :success then 'alert-success'
                  else 'alert-info'
                end %>
                <div class="alert cinema-alert <%= bs_class %> alert-dismissible fade show" role="alert" style="position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; min-width: 300px; max-width: 90vw;">
                  <%= message %>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              <% end %>
              <%= yield %>
            </div>
          </div>
        </div>
      </div>
    </main>
    <%= render 'layouts/footer' %>

    <!-- Chat Popup Widget using Stimulus (only for logged-in users) -->
    <% if current_user %>
      <div data-controller="chat">
        <div id="chat-popup" data-chat-target="popup" class="cinema-chat-popup" style="display:none;flex-direction:column;position:fixed;bottom:24px;right:24px;z-index:9999;max-width:350px;border-radius:12px;overflow:hidden;">
          <div class="cinema-chat-header" style="display:flex;align-items:center;justify-content:space-between;padding:0.75rem 1rem;background:#1E3A8A;color:#fff;font-weight:600;">
            <span><i class="fas fa-comments me-2"></i>Chat Support</span>
            <button type="button" data-chat-target="close" class="cinema-chat-close" style="background:none;border:none;color:#fff;font-size:1.2em;cursor:pointer;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="cinema-chat-messages" data-chat-target="messages" style="flex:1;overflow-y:auto;padding:1rem;background:rgba(15,23,42,0.98);min-height:120px;max-height:300px;">
            <div><i class="fas fa-robot me-2"></i>Hi! How can we help you today?</div>
          </div>
          <form data-chat-target="form" class="cinema-chat-form" style="display:flex;gap:0.5rem;padding:0.75rem 1rem;background:#16213e;">
            <textarea data-chat-target="input" placeholder="Type your message..." rows="1" class="cinema-chat-input" style="flex:1;border-radius:8px;border:1px solid #3B82F6;padding:0.5rem;resize:none;"></textarea>
            <button type="submit" class="cinema-chat-send" style="background:#3B82F6;border:none;border-radius:8px;color:#fff;padding:0.5rem 1rem;font-size:1em;cursor:pointer;">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </div>
        <button type="button" data-chat-target="open" class="cinema-chat-button" style="position:fixed;bottom:24px;right:24px;z-index:9998;">
          <i class="fas fa-comments"></i>
        </button>
      </div>
    <% end %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
